<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="boardMapper">
	
	<resultMap id="boardResultSet" type="board">
		<result column="FREE_BOARD_NO" property="freeBoardNo" />
		<result column="BOARD_TITLE" property="boardTitle" />
		<result column="BOARD_CONTENT" property="boardContent" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="NICKNAME" property="nickname" />
		<result column="MEMBER_NO" property="memberNo" />
		<result column="MEMBER_NAME" property="memberName"/>
		<result column="COUNT" property="count" />
		<result column="PLATFORM_NAME" property="platformName" />
		<result column="REVIEW_COUNT" property="reviewCount" />
		<result column="ORIGIN_NAME" property="originName" />
		<result column="CHANGE_NAME" property="changeName" />
		<result column="IMAGE_PATH" property="imagePath" />
		
		<collection property="replies" ofType="Reply">
			<result column="REVIEW_NO" property="reviewNo" />
			<result column="REVIEW_CONTENT" property="reviewContent" />
			<result column="REVIEWCREATEDATE" property="createDate" />
			<result column="REVIEWWRITER" property="reviewWriter" />
		</collection>
	</resultMap>


	<select id="selectListCount"
	parameterType="_int"
	resultType="_int"
	>
	SELECT
	      COUNT(*)
	  FROM
	      FREE_BOARD
	 WHERE
	      DELETE_YN = 'N'
	  <if test="categoryNo > 0">
	   AND PLATFORM_NO = #{categoryNo}
	  </if>         
	</select>
	
	
	<select id="seleltListAll"
	parameterType="_int"
	resultMap="boardResultSet">
	SELECT
	       FREE_BOARD.FREE_BOARD_NO,
	       BOARD_TITLE,
	       BOARD_CONTENT,
	       CREATE_DATE,
	       ORIGIN_NAME,
	       CHANGE_NAME,
	       IMAGE_PATH,
	       MEMBER.NICKNAME AS "NICKNAME",
           COUNT,
	       PLATFORM_NAME,
           NVL(RCOUNT, 0) AS "REVIEW_COUNT"
	  FROM
	       FREE_BOARD
	  JOIN MEMBER
	    ON MEMBER.MEMBER_NO = FREE_BOARD.MEMBER_NO
      JOIN PLATFORM_CATEGORY
        ON PLATFORM_CATEGORY.PLATFORM_NO = FREE_BOARD.PLATFORM_NO
      LEFT  
      JOIN (SELECT
                 FREE_BOARD_NO,   
                 COUNT(FREE_BOARD_NO) AS "RCOUNT"
                 FROM    
                     FREE_BOARD_REVIEW         
                WHERE
                     DELETE_YN = 'N'
                GROUP     
                   BY FREE_BOARD_NO) R
        ON FREE_BOARD.FREE_BOARD_NO = R.FREE_BOARD_NO          
	 WHERE
	      FREE_BOARD.DELETE_YN = 'N'
	 <if test="category > 0">
	 	AND FREE_BOARD.PLATFORM_NO = #{categoryNo}
	 </if>
	 ORDER
	    BY
	      FREE_BOARD_NO DESC   
	</select>
	
	
	<insert id="insertBoard"
		parameterType="board"
	>
	INSERT
	  INTO
	      FREE_BOARD
	      (
	       FREE_BOARD_NO,
	       BOARD_TITLE,
	       BOARD_CONTENT,
	       MEMBER_NO,
	       PLATFORM_NO,
	       ORIGIN_NAME,
	       CHANGE_NAME,
	       IMAGE_PATH
	      )
	VALUES
	      (
	       SEQ_FREE_BOARD.nextval,
	       #{boardTitle},
	       #{boardContent},
	       #{memberNo},
	       #{platformNo},
	       #{originName},
	       #{changeName},
	       #{imagePath}  
	      )        
	</insert>
	
	
	<update id="increaseCount"
		parameterType="_int"
	>
	UPDATE
	      FREE_BOARD
	   SET
	      COUNT = COUNT + 1
	 WHERE
	      FREE_BOARD_NO = #{boardNo}
	</update>
	
	
	<select id="selectBoard"
		parameterType="_int"
		resultMap="boardResultSet"
	>
	SELECT
	       FREE_BOARD.FREE_BOARD_NO,
	       BOARD_TITLE,
	       BOARD_CONTENT,
	       FREE_BOARD.CREATE_DATE,
	       ORIGIN_NAME,
	       CHANGE_NAME,
	       IMAGE_PATH,
	       MEMBER.MEMBER_NO AS "MEMBER_NO",
	       MEMBER.MEMBER_NAME AS "MEMBER_NAME",
	       MEMBER.NICKNAME AS "NICKNAME",
           COUNT,
           PLATFORM_CATEGORY.PLATFORM_NO,
	       PLATFORM_NAME,
           REVIEW_CONTENT,
           REVIEWCREATEDATE,
           REVIEWWRITER,
           REVIEW_NO
	  FROM
	       FREE_BOARD
	  JOIN MEMBER
	    ON MEMBER.MEMBER_NO = FREE_BOARD.MEMBER_NO
      JOIN PLATFORM_CATEGORY
        ON PLATFORM_CATEGORY.PLATFORM_NO = FREE_BOARD.PLATFORM_NO
      LEFT  
      JOIN (SELECT
                 REVIEW_NO,
                 FREE_BOARD_NO,
                 REVIEW_CONTENT,
                 CREATE_DATE AS "REVIEWCREATEDATE",
                 MEMBER.MEMBER_NAME AS "REVIEWWRITER"
                 FROM    
                     FREE_BOARD_REVIEW
                 JOIN MEMBER
                   ON MEMBER.MEMBER_NO = FREE_BOARD_REVIEW.MEMBER_NO
                WHERE
                     FREE_BOARD_REVIEW.DELETE_YN = 'N') R
        ON FREE_BOARD.FREE_BOARD_NO = R.FREE_BOARD_NO
	 WHERE
	      FREE_BOARD.DELETE_YN = 'N'
       AND
          MEMBER.DELETE_YN = 'N'
	   AND
	      FREE_BOARD.FREE_BOARD_NO  = #{boardNo}            
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	










</mapper>